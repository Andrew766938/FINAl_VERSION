<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Betony - Social Blog Platform</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --primary: #9333ea;
      --primary-dark: #7e22ce;
      --primary-light: #a855f7;
      --secondary: #ec4899;
      --danger: #ef4444;
      --success: #10b981;
      --bg-dark: #1a0a2e;
      --bg-light: #16213e;
      --surface: #0f3460;
      --text-white: #ffffff;
      --text-light: #e0e7ff;
      --text-muted: #a0aec0;
      --border: #334155;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, var(--bg-dark) 0%, #2d1b4e 100%);
      color: var(--text-white);
      min-height: 100vh;
    }
    
    /* ===== AUTH SCREEN ===== */
    .auth-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: linear-gradient(135deg, var(--bg-dark) 0%, #3d1f5c 100%);
    }
    
    .auth-box {
      background: linear-gradient(135deg, var(--bg-light) 0%, var(--surface) 100%);
      border-radius: 24px;
      box-shadow: 0 25px 50px rgba(147, 51, 234, 0.3);
      overflow: hidden;
      max-width: 500px;
      width: 100%;
      border: 1px solid rgba(168, 85, 247, 0.2);
    }
    
    .auth-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      padding: 50px 30px;
      text-align: center;
      color: white;
    }
    
    .auth-logo {
      font-size: 2.8rem;
      margin-bottom: 15px;
      font-weight: 800;
      letter-spacing: -1px;
    }
    
    .auth-subtitle {
      font-size: 0.95rem;
      opacity: 0.95;
    }
    
    .auth-content {
      padding: 40px 30px;
    }
    
    .auth-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 2px solid var(--border);
    }
    
    .auth-tab {
      flex: 1;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-muted);
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
    }
    
    .auth-tab.active {
      color: var(--primary-light);
      border-bottom-color: var(--primary-light);
    }
    
    .auth-form {
      display: none;
    }
    
    .auth-form.active {
      display: block;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-light);
      font-size: 0.95rem;
    }
    
    .form-group input, .form-group textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-family: 'Inter', sans-serif;
      font-size: 1rem;
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-white);
      transition: all 0.3s;
    }
    
    .form-group input::placeholder,
    .form-group textarea::placeholder {
      color: var(--text-muted);
    }
    
    .form-group input:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--primary-light);
      background: rgba(255, 255, 255, 0.08);
      box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
    }
    
    .test-data-hint {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 20px;
      font-size: 0.9rem;
      color: var(--text-light);
      text-align: center;
    }
    
    .test-data-hint strong {
      color: var(--success);
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Inter', sans-serif;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      width: 100%;
    }
    
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(147, 51, 234, 0.4);
    }
    
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .btn-small {
      padding: 8px 16px;
      font-size: 0.9rem;
      width: auto;
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-secondary {
      background: rgba(168, 85, 247, 0.15);
      color: var(--primary-light);
      border: 1px solid rgba(168, 85, 247, 0.3);
    }
    
    .btn-secondary:hover:not(:disabled) {
      background: rgba(168, 85, 247, 0.25);
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .form-error {
      color: var(--danger);
      font-size: 0.9rem;
      margin-top: 5px;
      padding: 10px;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 6px;
      border-left: 3px solid var(--danger);
    }
    
    .form-success {
      color: var(--success);
      font-size: 0.9rem;
      margin-top: 5px;
      padding: 10px;
      background: rgba(16, 185, 129, 0.1);
      border-radius: 6px;
      border-left: 3px solid var(--success);
    }
    
    .form-loading {
      color: #3b82f6;
      font-size: 0.9rem;
      margin-top: 5px;
      padding: 10px;
      background: rgba(59, 130, 246, 0.1);
      border-radius: 6px;
      border-left: 3px solid #3b82f6;
    }
    
    /* ===== MAIN APP ===== */
    .app-container {
      display: none;
      min-height: 100vh;
      background: linear-gradient(135deg, var(--bg-dark) 0%, #2d1b4e 100%);
    }
    
    .app-container.active {
      display: flex;
      flex-direction: column;
    }
    
    .navbar {
      background: linear-gradient(90deg, rgba(147, 51, 234, 0.1) 0%, rgba(236, 72, 153, 0.05) 100%);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(168, 85, 247, 0.2);
      padding: 0 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 70px;
    }
    
    .navbar-brand {
      font-size: 1.8rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--secondary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .navbar-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
      padding-right: 20px;
      border-right: 1px solid rgba(168, 85, 247, 0.2);
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
    }
    
    .logout-btn {
      background: rgba(239, 68, 68, 0.2);
      color: var(--danger);
      border: 1px solid rgba(239, 68, 68, 0.3);
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .logout-btn:hover {
      background: rgba(239, 68, 68, 0.3);
    }
    
    .main-content {
      display: flex;
      flex: 1;
    }
    
    .sidebar {
      width: 250px;
      background: rgba(15, 52, 96, 0.5);
      backdrop-filter: blur(10px);
      border-right: 1px solid rgba(168, 85, 247, 0.2);
      padding: 30px 0;
    }
    
    .nav-item {
      padding: 15px 30px;
      cursor: pointer;
      border-left: 4px solid transparent;
      transition: all 0.3s;
      font-weight: 500;
      color: var(--text-muted);
    }
    
    .nav-item:hover {
      background: rgba(168, 85, 247, 0.1);
      color: var(--primary-light);
    }
    
    .nav-item.active {
      border-left-color: var(--primary-light);
      background: rgba(168, 85, 247, 0.2);
      color: var(--primary-light);
    }
    
    .content {
      flex: 1;
      padding: 40px;
      overflow-y: auto;
    }
    
    .tabs-content {
      display: none;
    }
    
    .tabs-content.active {
      display: block;
    }
    
    /* ===== POSTS ===== */
    .post-form {
      background: linear-gradient(135deg, rgba(147, 51, 234, 0.1) 0%, rgba(236, 72, 153, 0.05) 100%);
      border: 1px solid rgba(168, 85, 247, 0.2);
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(147, 51, 234, 0.15);
      margin-bottom: 30px;
      backdrop-filter: blur(10px);
    }
    
    .post-form h2 {
      font-size: 1.5rem;
      margin-bottom: 25px;
      color: var(--text-white);
    }
    
    .posts-grid {
      display: grid;
      gap: 24px;
    }
    
    .post {
      background: linear-gradient(135deg, rgba(147, 51, 234, 0.08) 0%, rgba(236, 72, 153, 0.03) 100%);
      border: 1px solid rgba(168, 85, 247, 0.15);
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(147, 51, 234, 0.1);
      transition: all 0.3s;
      backdrop-filter: blur(10px);
    }
    
    .post:hover {
      transform: translateY(-4px);
      border-color: rgba(168, 85, 247, 0.3);
      box-shadow: 0 8px 24px rgba(147, 51, 234, 0.2);
    }
    
    .post-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }
    
    .post h3 {
      font-size: 1.4rem;
      color: var(--text-white);
      margin-bottom: 8px;
    }
    
    .post-meta {
      color: var(--text-muted);
      font-size: 0.9rem;
    }
    
    .post-author {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }
    
    .post-avatar {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: white;
      font-size: 0.8rem;
    }
    
    .post p {
      color: var(--text-light);
      line-height: 1.6;
      margin-bottom: 20px;
    }
    
    .post-stats {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(168, 85, 247, 0.15);
      font-size: 0.9rem;
      color: var(--text-muted);
    }
    
    .post-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .users-list,
    .friends-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .user-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-radius: 12px;
      background: rgba(15, 52, 96, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    .user-main {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .user-name {
      font-weight: 600;
      color: var(--text-white);
    }

    .user-email {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .user-actions button {
      margin-left: 8px;
    }

    .profile-card {
      background: rgba(15, 52, 96, 0.85);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 16px;
      align-items: center;
    }

    .profile-meta {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .profile-meta div {
      font-size: 0.95rem;
    }

    .profile-label {
      color: var(--text-muted);
      margin-right: 4px;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }
    
    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 20px;
    }

    /* Comment section */
    .comments-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid rgba(168, 85, 247, 0.15);
    }

    .comment-form {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .comment-form input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid rgba(168, 85, 247, 0.2);
      border-radius: 8px;
      font-size: 0.9rem;
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-white);
    }

    .comment-form input::placeholder {
      color: var(--text-muted);
    }

    .comment-item {
      padding: 10px 0;
      border-bottom: 1px solid rgba(168, 85, 247, 0.1);
      font-size: 0.9rem;
    }

    .comment-item:last-child {
      border-bottom: none;
    }

    .comment-author {
      font-weight: 600;
      color: var(--primary-light);
      margin-bottom: 4px;
    }

    .comment-content {
      color: var(--text-light);
    }
    
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(168, 85, 247, 0.1);
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(168, 85, 247, 0.3);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(168, 85, 247, 0.5);
    }
  </style>
</head>
<body>
  <!-- AUTH SCREEN -->
  <div id="authScreen" class="auth-container">
    <div class="auth-box">
      <div class="auth-header">
        <div class="auth-logo">üåø Betony</div>
        <div class="auth-subtitle">–°–æ—Ü–∏–∞–ª—å–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –±–ª–æ–≥–æ–≤</div>
      </div>
      <div class="auth-content">
        <div class="auth-tabs">
          <button class="auth-tab active" onclick="switchAuthTab('login')">–í—Ö–æ–¥</button>
          <button class="auth-tab" onclick="switchAuthTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>
        
        <!-- LOGIN FORM -->
        <form class="auth-form active" id="loginForm" onsubmit="handleLogin(event)">
          <div class="test-data-hint">
            üí° –¢–µ—Å—Ç: <strong>alice@betony.local</strong> / <strong>password123</strong>
          </div>
          
          <div class="form-group">
            <label for="loginEmail">Email</label>
            <input type="email" id="loginEmail" required placeholder="user@example.com" autocomplete="off">
          </div>
          <div class="form-group">
            <label for="loginPassword">–ü–∞—Ä–æ–ª—å</label>
            <input type="password" id="loginPassword" required placeholder="–í–∞—à –ø–∞—Ä–æ–ª—å" autocomplete="off">
          </div>
          <div id="loginStatus" style="display: none;"></div>
          <button type="submit" class="btn btn-primary" id="loginBtn">–í–æ–π—Ç–∏</button>
        </form>
        
        <!-- REGISTER FORM -->
        <form class="auth-form" id="registerForm" onsubmit="handleRegister(event)">
          <div class="form-group">
            <label for="regUsername">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
            <input type="text" id="regUsername" required placeholder="–í–∞—à–µ –∏–º—è">
          </div>
          <div class="form-group">
            <label for="regEmail">Email</label>
            <input type="email" id="regEmail" required placeholder="user@example.com">
          </div>
          <div class="form-group">
            <label for="regPassword">–ü–∞—Ä–æ–ª—å</label>
            <input type="password" id="regPassword" required placeholder="–í–∞—à –ø–∞—Ä–æ–ª—å">
          </div>
          <div class="form-group">
            <label for="regPasswordConfirm">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
            <input type="password" id="regPasswordConfirm" required placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
          </div>
          <div id="regStatus" style="display: none;"></div>
          <button type="submit" class="btn btn-primary" id="regBtn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        </form>
      </div>
    </div>
  </div>
  
  <!-- MAIN APP -->
  <div id="appScreen" class="app-container">
    <nav class="navbar">
      <div class="navbar-brand">üåø Betony</div>
      <div class="navbar-right">
        <div class="user-info">
          <span id="currentUserName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
          <div class="user-avatar" id="userAvatar">U</div>
          <button type="button" class="logout-btn" onclick="logout()">–í—ã—Ö–æ–¥</button>
        </div>
      </div>
    </nav>
    
    <div class="main-content">
      <aside class="sidebar">
        <div class="nav-item active" onclick="switchTab(event, 'feed')">üì∞ –õ–µ–Ω—Ç–∞</div>
        <div class="nav-item" onclick="switchTab(event, 'users')">üë• –õ—é–¥–∏</div>
        <div class="nav-item" onclick="switchTab(event, 'friends')">‚ù§Ô∏è –î—Ä—É–∑—å—è</div>
        <div class="nav-item" onclick="switchTab(event, 'profile')">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
      </aside>
      
      <main class="content">
        <!-- FEED TAB -->
        <div id="feedTab" class="tabs-content active">
          <div class="post-form">
            <h2>‚ú® –°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –ø–æ—Å—Ç</h2>
            <form id="createPostForm" onsubmit="handleCreatePost(event)">
              <div class="form-group">
                <label for="postTitle">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
                <input type="text" id="postTitle" required placeholder="–û —á—ë–º –≤—ã —Ö–æ—Ç–∏—Ç–µ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å?">
              </div>
              <div class="form-group">
                <label for="postContent">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</label>
                <textarea id="postContent" required placeholder="–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–∏–º–∏ –º—ã—Å–ª—è–º–∏..." rows="5"></textarea>
              </div>
              <button type="submit" class="btn btn-primary" id="createPostBtn">üìù –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </form>
          </div>
          
          <div id="postsContainer" class="posts-grid"></div>
        </div>
        
        <!-- USERS TAB -->
        <div id="usersTab" class="tabs-content">
          <h2 style="margin-bottom: 20px; color: var(--text-white);">üë´ –õ—é–¥–∏</h2>
          <div id="usersContainer" class="users-list"></div>
        </div>
        
        <!-- FRIENDS TAB -->
        <div id="friendsTab" class="tabs-content">
          <h2 style="margin-bottom: 20px; color: var(--text-white);">‚ù§Ô∏è –î—Ä—É–∑—å—è</h2>
          <div id="friendsContainer" class="friends-list"></div>
        </div>
        
        <!-- PROFILE TAB -->
        <div id="profileTab" class="tabs-content">
          <h2 style="margin-bottom: 20px; color: var(--text-white);">üë§ –ü—Ä–æ—Ñ–∏–ª—å</h2>
          <div id="profileContainer"></div>
        </div>
      </main>
    </div>
  </div>
  
  <script>
    const API_URL = 'http://localhost:8000';
    let currentUser = null;
    let authToken = null;
    let allUsersCache = [];
    let friendshipsCache = [];
    let postsCache = [];

    async function apiCall(endpoint, options = {}) {
      const headers = {
        'Content-Type': 'application/json',
        ...options.headers
      };
      
      if (authToken) {
        headers['Authorization'] = `Bearer ${authToken}`;
      }
      
      try {
        const response = await fetch(`${API_URL}${endpoint}`, {
          ...options,
          headers
        });
        console.log(`[API] ${options.method || 'GET'} ${endpoint} - Status: ${response.status}`);
        return response;
      } catch (error) {
        console.error(`[API] Error on ${endpoint}:`, error);
        throw error;
      }
    }
    
    function switchAuthTab(tab) {
      document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
      document.getElementById('loginStatus').style.display = 'none';
      document.getElementById('regStatus').style.display = 'none';
      
      event.target.classList.add('active');
      document.getElementById(tab === 'login' ? 'loginForm' : 'registerForm').classList.add('active');
    }
    
    function showStatus(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.className = type === 'error' ? 'form-error' : type === 'success' ? 'form-success' : 'form-loading';
      element.textContent = message;
      element.style.display = 'block';
    }
    
    async function handleLogin(e) {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      const loginBtn = document.getElementById('loginBtn');
      
      if (!email || !password) {
        showStatus('loginStatus', '‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
        return;
      }
      
      loginBtn.disabled = true;
      showStatus('loginStatus', '‚è≥ –í—Ö–æ–¥–∏–º...', 'loading');
      
      try {
        const response = await fetch(`${API_URL}/auth/login`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ email, password })
        });
        
        const data = await response.json();
        console.log('[AUTH] Login response:', {status: response.status, has_token: !!data.access_token});
        
        if (response.ok && data.access_token) {
          authToken = data.access_token;
          currentUser = data.user || { username: email.split('@')[0] };
          showStatus('loginStatus', '‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!', 'success');
          setTimeout(showApp, 500);
        } else {
          const errorMsg = data.detail || data.error || '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
          showStatus('loginStatus', '‚ùå ' + errorMsg, 'error');
        }
      } catch (error) {
        console.error('[AUTH] Login error:', error);
        showStatus('loginStatus', '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
      } finally {
        loginBtn.disabled = false;
      }
    }
    
    async function handleRegister(e) {
      e.preventDefault();
      const username = document.getElementById('regUsername').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const password = document.getElementById('regPassword').value;
      const passwordConfirm = document.getElementById('regPasswordConfirm').value;
      const regBtn = document.getElementById('regBtn');
      
      if (!username || !email || !password || !passwordConfirm) {
        showStatus('regStatus', '‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
        return;
      }
      
      if (password !== passwordConfirm) {
        showStatus('regStatus', '‚ùå –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error');
        return;
      }
      
      if (password.length < 6) {
        showStatus('regStatus', '‚ùå –ü–∞—Ä–æ–ª—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
        return;
      }
      
      regBtn.disabled = true;
      showStatus('regStatus', '‚è≥ –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º—Å—è...', 'loading');
      
      try {
        const response = await fetch(`${API_URL}/auth/register`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ email, password, name: username })
        });
        
        const data = await response.json();
        
        if (response.ok && data.access_token) {
          authToken = data.access_token;
          currentUser = data.user || { username: username };
          showStatus('regStatus', '‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!', 'success');
          setTimeout(showApp, 500);
        } else {
          const errorMsg = data.detail || data.error || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';
          showStatus('regStatus', '‚ùå ' + errorMsg, 'error');
        }
      } catch (error) {
        console.error('[AUTH] Register error:', error);
        showStatus('regStatus', '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
      } finally {
        regBtn.disabled = false;
      }
    }
    
    async function showApp() {
      document.getElementById('authScreen').style.display = 'none';
      document.getElementById('appScreen').classList.add('active');
      
      const username = currentUser.username || currentUser.name || 'User';
      const initials = username.substring(0, 2).toUpperCase();
      document.getElementById('currentUserName').textContent = username;
      document.getElementById('userAvatar').textContent = initials;

      await Promise.all([
        loadPosts(),
        loadUsers(),
        loadFriendships(),
        renderProfile()
      ]);
    }
    
    function logout() {
      currentUser = null;
      authToken = null;
      document.getElementById('appScreen').classList.remove('active');
      document.getElementById('authScreen').style.display = 'flex';
      document.getElementById('loginForm').reset();
      document.getElementById('registerForm').reset();
      document.getElementById('loginStatus').style.display = 'none';
      document.getElementById('regStatus').style.display = 'none';
      document.getElementById('postsContainer').innerHTML = '';
      document.getElementById('usersContainer').innerHTML = '';
      document.getElementById('friendsContainer').innerHTML = '';
      document.getElementById('profileContainer').innerHTML = '';
      allUsersCache = [];
      friendshipsCache = [];
      postsCache = [];
    }
    
    function switchTab(e, tab) {
      document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
      document.querySelectorAll('.tabs-content').forEach(content => content.classList.remove('active'));
      
      e.target.classList.add('active');
      document.getElementById(tab + 'Tab').classList.add('active');
    }

    function createUserAvatar(name) {
      const initials = (name || '?').substring(0, 2).toUpperCase();
      const span = document.createElement('div');
      span.className = 'post-avatar';
      span.textContent = initials;
      return span;
    }

    async function loadPosts() {
      try {
        console.log('[POSTS] Loading posts...');
        const res = await apiCall('/posts/');
        const data = await res.json();
        postsCache = data;
        const container = document.getElementById('postsContainer');
        container.innerHTML = '';

        if (!res.ok || !Array.isArray(data) || data.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'empty-state';
          empty.innerHTML = '<div class="empty-state-icon">üìù</div><p>–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π!</p>';
          container.appendChild(empty);
          return;
        }

        data.forEach(post => {
          const el = document.createElement('div');
          el.className = 'post';
          const authorName = post.author_name || post.user?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞–≤—Ç–æ—Ä';
          const authorEmail = post.author_email || post.user?.email || 'user';
          el.innerHTML = `
            <div class="post-header">
              <div style="flex: 1;">
                <div class="post-author">
                  ${createUserAvatar(authorName).outerHTML}
                  <div>
                    <div style="font-weight: 600; color: var(--text-white);">${authorName}</div>
                    <div class="post-meta">@${authorEmail}</div>
                  </div>
                </div>
                <h3>${post.title}</h3>
              </div>
            </div>
            <p>${post.content}</p>
            <div class="post-stats">
              <span id="likes-count-${post.id}">‚ù§Ô∏è –õ–∞–π–∫–æ–≤: 0</span>
            </div>
            <div class="post-actions">
              <button class="btn btn-small btn-secondary" onclick="likePost(${post.id})">‚ù§Ô∏è –õ–∞–π–∫</button>
              <button class="btn btn-small btn-secondary" onclick="toggleComments(${post.id})">üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
            </div>
            <div id="comments-section-${post.id}" class="comments-section" style="display: none;">
              <div class="comment-form">
                <input type="text" id="comment-input-${post.id}" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...">
                <button class="btn btn-small btn-secondary" onclick="submitComment(${post.id})">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
              </div>
              <div id="comments-list-${post.id}"></div>
            </div>
          `;
          container.appendChild(el);
          loadPostComments(post.id);
          updateLikesCount(post.id);
        });
      } catch (e) {
        console.error('[POSTS] Error loading posts:', e);
      }
    }

    async function loadUsers() {
      try {
        console.log('[USERS] Loading users...');
        const res = await apiCall('/auth/users');
        const data = await res.json();
        const container = document.getElementById('usersContainer');
        container.innerHTML = '';

        if (!res.ok || !Array.isArray(data) || data.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'empty-state';
          empty.innerHTML = '<div class="empty-state-icon">üë•</div><p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–∫–∞ –Ω–µ—Ç.</p>';
          container.appendChild(empty);
          return;
        }

        allUsersCache = data;

        data.forEach(user => {
          const card = document.createElement('div');
          card.className = 'user-card';

          const main = document.createElement('div');
          main.className = 'user-main';
          main.appendChild(createUserAvatar(user.username || user.email));

          const meta = document.createElement('div');
          meta.className = 'user-meta';
          meta.innerHTML = `
            <div class="user-name">${user.username || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</div>
            <div class="user-email">${user.email}</div>
          `;
          main.appendChild(meta);

          const actions = document.createElement('div');
          actions.className = 'user-actions';

          const friendBtn = document.createElement('button');
          friendBtn.className = 'btn btn-small btn-secondary';
          friendBtn.type = 'button';
          
          const isAlreadyFriend = friendshipsCache.some(f => f.user_id === currentUser.id && f.friend_id === user.id);
          if (isAlreadyFriend) {
            friendBtn.textContent = '‚úÖ –î—Ä—É–≥';
            friendBtn.disabled = true;
            friendBtn.style.opacity = '0.6';
            friendBtn.style.cursor = 'default';
          } else if (user.id === currentUser.id) {
            friendBtn.textContent = 'üëë –í—ã';
            friendBtn.disabled = true;
            friendBtn.style.opacity = '0.6';
            friendBtn.style.cursor = 'default';
          } else {
            friendBtn.textContent = '‚ù§Ô∏è –î–æ–±–∞–≤–∏—Ç—å';
            friendBtn.onclick = async () => {
              friendBtn.disabled = true;
              console.log('[FRIENDS] Adding friend:', user.id);
              await addFriend(user.id);
              friendBtn.disabled = false;
            };
          }

          actions.appendChild(friendBtn);

          card.appendChild(main);
          card.appendChild(actions);

          container.appendChild(card);
        });
      } catch (e) {
        console.error('[USERS] Error loading users:', e);
      }
    }

    async function loadFriendships() {
      try {
        console.log('[FRIENDSHIPS] Loading friendships...');
        const res = await apiCall('/friendships/');
        if (!res.ok) {
          console.error('[FRIENDSHIPS] Failed to load:', res.status);
          return;
        }
        const data = await res.json();
        console.log('[FRIENDSHIPS] Loaded:', data.length, 'friendships');
        friendshipsCache = data;
        renderFriends();
      } catch (e) {
        console.error('[FRIENDSHIPS] Error loading friendships:', e);
      }
    }

    async function addFriend(friendId) {
      try {
        console.log('[FRIENDS] Attempting to add friend:', friendId);
        const res = await apiCall(`/friendships/${friendId}`, {
          method: 'POST',
          body: JSON.stringify({})
        });
        
        const data = await res.json();
        console.log('[FRIENDS] Response:', {status: res.status, data});
        
        if (res.ok) {
          console.log('[FRIENDS] Successfully added friend');
          await loadFriendships();
          await loadUsers();
          alert('‚úÖ –î—Ä—É–≥ –¥–æ–±–∞–≤–ª–µ–Ω!');
        } else {
          alert('‚ùå ' + (data.detail || '–û—à–∏–±–∫–∞'));
        }
      } catch (e) {
        console.error('[FRIENDS] Error:', e);
        alert('‚ùå –û—à–∏–±–∫–∞: ' + e.message);
      }
    }

    function renderFriends() {
      const container = document.getElementById('friendsContainer');
      container.innerHTML = '';
      if (!currentUser || !allUsersCache.length || !friendshipsCache.length) {
        const empty = document.createElement('div');
        empty.className = 'empty-state';
        empty.innerHTML = '<div class="empty-state-icon">üë¨</div><p>–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –¥—Ä—É–∑—å—è—Ö.</p>';
        container.appendChild(empty);
        return;
      }

      const myId = currentUser.id;
      const friendIds = friendshipsCache
        .filter(f => f.user_id === myId)
        .map(f => f.friend_id);

      const myFriends = allUsersCache.filter(u => friendIds.includes(u.id));

      if (!myFriends.length) {
        const empty = document.createElement('div');
        empty.className = 'empty-state';
        empty.innerHTML = '<div class="empty-state-icon">üë¨</div><p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–∑–µ–π. –î–æ–±–∞–≤—å—Ç–µ –∫–æ–≥–æ‚Äë–Ω–∏–±—É–¥—å –≤–æ –≤–∫–ª–∞–¥–∫–µ "–õ—é–¥–∏".</p>';
        container.appendChild(empty);
        return;
      }

      myFriends.forEach(user => {
        const card = document.createElement('div');
        card.className = 'user-card';

        const main = document.createElement('div');
        main.className = 'user-main';
        main.appendChild(createUserAvatar(user.username || user.email));

        const meta = document.createElement('div');
        meta.className = 'user-meta';
        meta.innerHTML = `
          <div class="user-name">${user.username || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</div>
          <div class="user-email">${user.email}</div>
        `;
        main.appendChild(meta);

        card.appendChild(main);
        container.appendChild(card);
      });
    }

    async function renderProfile() {
      const container = document.getElementById('profileContainer');
      container.innerHTML = '';
      if (!currentUser) return;

      const card = document.createElement('div');
      card.className = 'profile-card';

      const avatar = createUserAvatar(currentUser.username || currentUser.email);
      card.appendChild(avatar);

      const meta = document.createElement('div');
      meta.className = 'profile-meta';
      meta.innerHTML = `
        <div><span class="profile-label">–ò–º—è:</span> ${currentUser.username || currentUser.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
        <div><span class="profile-label">Email:</span> ${currentUser.email || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
        <div><span class="profile-label">ID:</span> ${currentUser.id || '‚Äî'}</div>
      `;

      card.appendChild(meta);
      container.appendChild(card);
    }

    async function handleCreatePost(e) {
      e.preventDefault();
      const title = document.getElementById('postTitle').value.trim();
      const content = document.getElementById('postContent').value.trim();
      const createBtn = document.getElementById('createPostBtn');
      
      if (!title || !content) {
        alert('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
        return;
      }
      
      createBtn.disabled = true;
      console.log('[POST] Creating post with title:', title);
      
      try {
        const response = await apiCall('/posts/', {
          method: 'POST',
          body: JSON.stringify({ title, content })
        });
        
        const data = await response.json();
        console.log('[POST] Create response:', {status: response.status, id: data.id, error: data.detail});
        
        if (response.ok) {
          alert('‚úÖ –ü–æ—Å—Ç —Å–æ–∑–¥–∞–Ω!');
          document.getElementById('createPostForm').reset();
          await loadPosts();
        } else {
          const msg = data.detail || data.error || '–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞';
          alert('‚ùå –û—à–∏–±–∫–∞: ' + msg);
          console.log('[POST] Error details:', data);
        }
      } catch (error) {
        console.error('[POST] Exception:', error);
        alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
      } finally {
        createBtn.disabled = false;
      }
    }

    async function likePost(postId) {
      console.log('[LIKE] Liking post:', postId);
      try {
        const response = await apiCall(`/likes/${postId}`, {
          method: 'POST',
          body: JSON.stringify({})
        });
        
        const data = await response.json();
        console.log('[LIKE] Response:', {status: response.status, data});
        
        if (response.ok) {
          console.log('[LIKE] Successfully liked!');
          updateLikesCount(postId);
        } else {
          alert('‚ùå ' + (data.detail || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ª–∞–π–∫–µ'));
        }
      } catch (e) {
        console.error('[LIKE] Error:', e);
        alert('‚ùå –û—à–∏–±–∫–∞: ' + e.message);
      }
    }

    async function updateLikesCount(postId) {
      try {
        const res = await apiCall(`/likes/user/${currentUser.id}`);
        const likes = await res.json();
        const postLikes = likes.filter(l => l.post_id === postId).length;
        const el = document.getElementById(`likes-count-${postId}`);
        if (el) el.textContent = `‚ù§Ô∏è –õ–∞–π–∫–æ–≤: ${postLikes}`;
      } catch (e) {
        console.error('[LIKE] Error updating count:', e);
      }
    }

    function toggleComments(postId) {
      const section = document.getElementById(`comments-section-${postId}`);
      if (section) {
        section.style.display = section.style.display === 'none' ? 'block' : 'none';
      }
    }

    async function submitComment(postId) {
      const input = document.getElementById(`comment-input-${postId}`);
      const content = input.value.trim();
      
      if (!content) {
        alert('‚ùå –ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π');
        return;
      }
      
      try {
        console.log('[COMMENT] Creating comment on post:', postId);
        const response = await apiCall(`/comments/${postId}`, {
          method: 'POST',
          body: JSON.stringify({ content })
        });
        
        const data = await response.json();
        console.log('[COMMENT] Response:', {status: response.status, data});
        
        if (response.ok) {
          console.log('[COMMENT] Successfully created!');
          input.value = '';
          await loadPostComments(postId);
        } else {
          alert('‚ùå ' + (data.detail || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è'));
        }
      } catch (e) {
        console.error('[COMMENT] Error:', e);
        alert('‚ùå –û—à–∏–±–∫–∞: ' + e.message);
      }
    }

    async function loadPostComments(postId) {
      try {
        // This would need a GET endpoint to fetch comments for a post
        // For now, showing empty comments
        const listEl = document.getElementById(`comments-list-${postId}`);
        if (listEl) {
          listEl.innerHTML = '<p style="color: var(--text-muted); font-size: 0.9rem; text-align: center;">–ù–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</p>';
        }
      } catch (e) {
        console.error('[COMMENT] Error loading comments:', e);
      }
    }
  </script>
</body>
</html>
